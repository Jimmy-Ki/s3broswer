<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}S3 Finder{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/finder.css') }}" rel="stylesheet">
</head>
<body>
    {% block content %}{% endblock %}

    <!-- 模态框容器 -->
    <div id="modal-container"></div>

    
    <!-- 右键菜单 -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" onclick="refreshFiles()">
            <i class="bi bi-arrow-clockwise"></i> 刷新
        </div>
        <div class="context-menu-item" onclick="showUploadModal()">
            <i class="bi bi-cloud-upload"></i> 上传文件
        </div>
        <div class="context-menu-item" onclick="createFolder()">
            <i class="bi bi-folder-plus"></i> 新建文件夹
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="downloadSelected()" id="download-item" style="display: none;">
            <i class="bi bi-cloud-download"></i> 下载
        </div>
        <div class="context-menu-item" onclick="deleteSelected()" id="delete-item" style="display: none;">
            <i class="bi bi-trash"></i> 删除
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="showSettingsModal()">
            <i class="bi bi-gear"></i> 设置
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js"></script>
    <script>
        // 全局变量
        let currentServerId = null;
        let currentBucket = null;
        let currentPrefix = '';
        let selectedFiles = new Set();
        let selectedFile = null; // 当前选中的单个文件
        let multiSelectMode = false;
        let viewMode = 'grid'; // grid 或 list

        // 工具函数
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function showLoading() {
            document.getElementById('finder-files').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            `;
        }

        function hideContextMenu() {
            document.getElementById('context-menu').style.display = 'none';
        }

        // 文件选择
        function toggleFileSelection(key, element) {
            if (selectedFiles.has(key)) {
                selectedFiles.delete(key);
                element.classList.remove('selected');
            } else {
                selectedFiles.add(key);
                element.classList.add('selected');
            }
            updateContextMenuState();
        }

        function updateContextMenuState() {
            const downloadItem = document.getElementById('download-item');
            const deleteItem = document.getElementById('delete-item');

            if (selectedFiles.size > 0) {
                downloadItem.style.display = 'flex';
                deleteItem.style.display = 'flex';
            } else {
                downloadItem.style.display = 'none';
                deleteItem.style.display = 'none';
            }
        }

        // 右键菜单
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.style.display = 'block';
        });

        document.addEventListener('click', hideContextMenu);

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideContextMenu();
                // 关闭预览模态框
                const previewModal = document.getElementById('preview-modal');
                if (previewModal && previewModal.style.display === 'flex') {
                    previewModal.style.display = 'none';
                }
                selectedFiles.clear();
                document.querySelectorAll('.file-item.selected, .file-row.selected').forEach(el => {
                    el.classList.remove('selected');
                });
                updateContextMenuState();
            } else if (e.key === 'Delete' && selectedFiles.size > 0) {
                deleteSelected();
            } else if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                selectAllFiles();
            }
        });

        // 拖拽上传
        function setupDragAndDrop() {
            const dropZone = document.body;

            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', function(e) {
                if (e.target === dropZone) {
                    dropZone.classList.remove('dragover');
                }
            });

            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');

                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0 && currentServerId && currentBucket) {
                    uploadFiles(files);
                }
            });
        }

        // 视图切换
        function toggleView() {
            viewMode = viewMode === 'grid' ? 'list' : 'grid';
            document.getElementById('view-toggle').innerHTML = viewMode === 'grid' ?
                '<i class="bi bi-list"></i>' : '<i class="bi bi-grid"></i>';
            if (currentServerId && currentBucket) {
                loadFiles();
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            checkFirstRun();
            loadPersistedState();
        });

        // 首次运行检查
        function checkFirstRun() {
            fetch('/api/servers')
                .then(response => response.json())
                .then(data => {
                    if (data.servers.length === 0) {
                        showSettingsModal();
                    } else {
                        loadServers();
                    }
                });
        }

        // 占位函数 - 将被具体页面覆盖
        function loadServers() {}
        function loadFiles() {}
        function refreshFiles() {}
        function showUploadModal() {}
        function createFolder() {}
        function downloadSelected() {}
        function deleteSelected() {}
        function showSettingsModal() {}
        function uploadFiles(files) {}
        function selectAllFiles() {}

        // 页面切换时收起上传面板
        function onPageChange() {
            // 收起上传面板
            closeUploadManagement();
        }

        // 上传管理全局变量
        let uploadQueue = [];
        let uploadIdCounter = 0;

        // 上传管理函数
        function showUploadManagement() {
            // 显示上传管理面板（文件属性面板保持显示）
            document.getElementById('upload-management-panel').style.display = 'block';
            updateUploadList();
        }

        function closeUploadManagement() {
            // 隐藏上传管理面板
            document.getElementById('upload-management-panel').style.display = 'none';
        }

        function toggleUploadPanel() {
            const panel = document.getElementById('upload-management-panel');
            if (panel.style.display === 'none') {
                showUploadManagement();
            } else {
                closeUploadManagement();
            }
        }

        function addUploadTask(file, serverId, bucket, prefix) {
            const taskId = ++uploadIdCounter;
            const task = {
                id: taskId,
                file: file,
                serverId: serverId,
                bucket: bucket,
                prefix: prefix || '',
                status: 'pending', // pending, uploading, completed, error, cancelled
                progress: 0,
                startTime: null,
                endTime: null,
                error: null
            };

            uploadQueue.push(task);
            updateUploadList();
            return taskId;
        }

        function updateUploadTask(taskId, updates) {
            const task = uploadQueue.find(t => t.id === taskId);
            if (task) {
                Object.assign(task, updates);
                updateUploadList();
            }
        }

        function removeUploadTask(taskId) {
            const index = uploadQueue.findIndex(t => t.id === taskId);
            if (index > -1) {
                uploadQueue.splice(index, 1);
                updateUploadList();
            }
        }

        function clearCompletedUploads() {
            uploadQueue = uploadQueue.filter(task =>
                task.status !== 'completed' && task.status !== 'error'
            );
            updateUploadList();
        }

        function cancelAllUploads() {
            uploadQueue.forEach(task => {
                if (task.status === 'pending' || task.status === 'uploading') {
                    updateUploadTask(task.id, { status: 'cancelled' });
                }
            });
        }

        function updateUploadList() {
            const uploadList = document.getElementById('upload-list');
            const uploadStats = document.getElementById('upload-stats');

            const activeUploads = uploadQueue.filter(task =>
                task.status === 'uploading' || task.status === 'pending'
            );
            const completedUploads = uploadQueue.filter(task => task.status === 'completed').length;
            const totalSize = uploadQueue.reduce((sum, task) => sum + task.file.size, 0);

            uploadStats.textContent = `${activeUploads.length} 个进行中 | ${completedUploads} 个已完成 | 总计 ${formatFileSize(totalSize)}`;

            if (uploadQueue.length === 0) {
                uploadList.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-cloud-upload" style="font-size: 48px; color: var(--finder-text-secondary);"></i>
                        <p style="color: var(--finder-text-secondary); margin-top: 10px;">暂无上传任务</p>
                    </div>
                `;
                return;
            }

            let html = '';
            uploadQueue.forEach(task => {
                const statusClass = {
                    'pending': 'status-pending',
                    'uploading': 'status-uploading',
                    'completed': 'status-completed',
                    'error': 'status-error',
                    'cancelled': 'status-cancelled'
                }[task.status];

                const statusText = {
                    'pending': '等待中',
                    'uploading': '上传中',
                    'completed': '已完成',
                    'error': '失败',
                    'cancelled': '已取消'
                }[task.status];

                const progressVisible = task.status === 'uploading' ? 'visible' : 'hidden';
                const canCancel = task.status === 'pending' || task.status === 'uploading';
                const canRemove = task.status === 'completed' || task.status === 'error' || task.status === 'cancelled';

                html += `
                    <div class="upload-item ${statusClass}">
                        <div class="upload-item-info">
                            <div class="upload-item-name" title="${task.file.name}">
                                <i class="bi bi-file-earmark"></i>
                                ${task.file.name}
                            </div>
                            <div class="upload-item-details">
                                <span class="upload-item-status">${statusText}</span>
                                <span class="upload-item-size">${formatFileSize(task.file.size)}</span>
                            </div>
                        </div>
                        <div class="upload-item-controls">
                            <button class="btn btn-sm btn-cancel" onclick="cancelUpload(${task.id})"
                                style="display: ${canCancel ? 'inline-block' : 'none'};">
                                <i class="bi bi-x"></i>
                            </button>
                            <button class="btn btn-sm btn-remove" onclick="removeUploadTask(${task.id})"
                                style="display: ${canRemove ? 'inline-block' : 'none'};">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="upload-progress" style="display: ${progressVisible};">
                            <div class="upload-progress-bar" style="width: ${task.progress}%;"></div>
                        </div>
                        ${task.error ? `<div class="upload-error">${task.error}</div>` : ''}
                    </div>
                `;
            });

            uploadList.innerHTML = html;
        }

        function cancelUpload(taskId) {
            updateUploadTask(taskId, { status: 'cancelled' });
        }

        // 状态持久化功能
        function saveCurrentState() {
            const state = {
                serverId: currentServerId,
                bucket: currentBucket,
                prefix: currentPrefix,
                currentPage: currentPage,
                itemsPerPage: itemsPerPage,
                timestamp: Date.now()
            };
            localStorage.setItem('s3-finder-state', JSON.stringify(state));
        }

        function loadPersistedState() {
            try {
                const savedState = localStorage.getItem('s3-finder-state');
                if (savedState) {
                    const state = JSON.parse(savedState);

                    // 检查状态是否在24小时内
                    const isRecent = Date.now() - state.timestamp < 24 * 60 * 60 * 1000;

                    if (isRecent && state.serverId) {
                        // 恢复服务器状态
                        fetch('/api/servers')
                            .then(response => response.json())
                            .then(data => {
                                const server = data.servers.find(s => s.id === state.serverId);
                                if (server) {
                                    currentServerId = state.serverId;
                                    loadServers();

                                    // 如果有桶信息，恢复到桶级别
                                    if (state.bucket) {
                                        setTimeout(() => {
                                            navigateToBucket(state.bucket);
                                            if (state.prefix) {
                                                currentPrefix = state.prefix;
                                            }
                                            // 恢复分页设置
                                            if (state.currentPage) {
                                                currentPage = state.currentPage;
                                            }
                                            if (state.itemsPerPage) {
                                                itemsPerPage = state.itemsPerPage;
                                                // 更新分页显示设置
                                                const perPageSelect = document.getElementById('items-per-page');
                                                if (perPageSelect) {
                                                    perPageSelect.value = itemsPerPage;
                                                }
                                            }
                                            loadFiles();
                                        }, 500);
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('加载保存的状态失败:', error);
                                showAllServersBuckets();
                            });
                    } else {
                        // 状态过期或无效，显示所有服务器的桶
                        showAllServersBuckets();
                    }
                } else {
                    // 没有保存的状态，显示所有服务器的桶
                    showAllServersBuckets();
                }
            } catch (error) {
                console.error('解析保存的状态失败:', error);
                showAllServersBuckets();
            }
        }

        function showAllServersBuckets() {
            fetch('/api/servers')
                .then(response => response.json())
                .then(data => {
                    if (data.servers.length === 0) {
                        showSettingsModal();
                        return;
                    }

                    // 显示所有服务器的桶
                    displayAllBuckets(data.servers);
                })
                .catch(error => {
                    console.error('加载服务器失败:', error);
                    updateStatus('加载服务器失败', 'error');
                });
        }

        function displayAllBuckets(servers) {
            const filesContainer = document.getElementById('finder-files');
            filesContainer.innerHTML = '<div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--finder-text-secondary);"><div style="font-size: 48px; margin-bottom: 20px;"><i class="bi bi-cloud"></i></div><h3 style="margin-bottom: 10px;">正在加载存储桶...</h3></div>';

            let allBuckets = [];
            let loadedCount = 0;

            servers.forEach(server => {
                fetch(`/api/servers/${server.id}/buckets`)
                    .then(response => response.json())
                    .then(data => {
                        allBuckets.push(...data.buckets.map(bucket => ({
                            ...bucket,
                            serverId: server.id,
                            serverName: server.name
                        })));
                        loadedCount++;

                        if (loadedCount === servers.length) {
                            displayBucketsGrid(allBuckets);
                        }
                    })
                    .catch(error => {
                        console.error(`加载服务器 ${server.name} 的桶失败:`, error);
                        loadedCount++;

                        if (loadedCount === servers.length) {
                            displayBucketsGrid(allBuckets);
                        }
                    });
            });
        }

        function displayBucketsGrid(buckets) {
            const filesContainer = document.getElementById('finder-files');

            if (buckets.length === 0) {
                filesContainer.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--finder-text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 20px;">
                            <i class="bi bi-folder-x"></i>
                        </div>
                        <h3 style="margin-bottom: 10px;">暂无存储桶</h3>
                        <p>请先在S3服务中创建存储桶</p>
                        <button class="btn btn-primary" onclick="showSettingsModal()">
                            <i class="bi bi-gear"></i> 管理服务器
                        </button>
                    </div>
                `;
                showWelcomePanel();
                return;
            }

            let html = '<div class="files-grid">';
            buckets.forEach(bucket => {
                html += `
                    <div class="file-item" onclick="enterBucketFromAllServers('${bucket.serverId}', '${bucket.key}')" ondblclick="enterBucketFromAllServers('${bucket.serverId}', '${bucket.key}')">
                        <div class="file-icon">
                            <i class="bi bi-bucket"></i>
                        </div>
                        <div class="file-name">${bucket.name}</div>
                        <div class="file-size" style="font-size: 10px; color: var(--finder-text-secondary);">${bucket.serverName}</div>
                        <div class="file-size">${bucket.last_modified || ''}</div>
                    </div>
                `;
            });
            html += '</div>';

            filesContainer.innerHTML = html;
            showWelcomePanel();
            updateStatus(`显示 ${buckets.length} 个存储桶`, 'ready');
        }

        function enterBucketFromAllServers(serverId, bucketName) {
            currentServerId = serverId;
            currentBucket = bucketName;
            currentPrefix = '';
            navigationHistory = [{'bucket': bucketName, 'prefix': ''}];
            navigationIndex = 0;

            // 更新侧边栏选中状态
            loadServers();

            // 加载文件
            loadFiles();
            updateNavigationButtons();

            // 保存状态
            saveCurrentState();
        }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>